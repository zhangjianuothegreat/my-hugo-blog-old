<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lucky Direction Compass</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://js.stripe.com/v3/"></script>
</head>
<body class="flex flex-col items-center justify-center min-h-screen bg-gray-100">
    <div class="text-center">
        <h1 class="text-3xl font-bold mb-4">Lucky Direction Compass</h1>
        <div class="mb-4">
            <input id="year" type="number" placeholder="Birth Year (e.g., 1990)" class="border p-2 m-2">
            <input id="month" type="number" placeholder="Birth Month (1-12)" class="border p-2 m-2">
            <input id="day" type="number" placeholder="Birth Day (1-31)" class="border p-2 m-2">
        </div>
        <button onclick="calculateLuckyDirection()" class="bg-blue-500 text-white p-2 rounded m-2">Find Lucky Direction</button>
        <button onclick="initiatePayment('monthly')" class="bg-green-500 text-white p-2 rounded m-2">Subscribe for $1.99/month</button>
        <button onclick="initiatePayment('one-time')" class="bg-green-500 text-white p-2 rounded m-2">Buy for $14.99</button>
        <button onclick="enableCompass()" class="bg-purple-500 text-white p-2 rounded m-2">Enable Compass</button>
        <p id="lucky-info" class="mt-4"></p>
        <canvas id="compass" width="200" height="200" class="mt-4"></canvas>
    </div>
    <script>
        const stripe = Stripe('pk_test_51RaUyRQmhFsssNQg2vJNcMhJWsthgnlRzVBdeuNtfyJAkuB5SSvhE1teDKyUI0zynTQaY9MLKh8xk7pegpLxKmAC008zJSXDap');
        let luckyAngle = 0;

        function checkPaymentStatus() {
            return localStorage.getItem('lucky_direction_paid') === 'true';
        }

        async function initiatePayment(type) {
            try {
                const priceId = type === 'monthly' ? 'price_1RqquTQmhFsssNQgZVYNYSoT' : 'price_1Rqqz4QmhFsssNQg0gC7Fkhj';
                const response = await fetch('/zen/api/create-checkout-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        priceId: priceId,
                        mode: type === 'monthly' ? 'subscription' : 'payment',
                        success_url: 'http://192.168.8.112/zen/lucky_direction/success.html',
                        cancel_url: 'http://192.168.8.112/zen/lucky_direction/cancel.html'
                    })
                });
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(`HTTP error! Status: ${response.status}, Message: ${error.error.message}`);
                }
                const session = await response.json();
                if (!session.id) {
                    throw new Error('No session ID returned from Stripe');
                }
                const { error } = await stripe.redirectToCheckout({ sessionId: session.id });
                if (error) {
                    throw new Error(error.message);
                }
            } catch (error) {
                console.error('Payment error:', error);
                document.getElementById('lucky-info').innerText = 'Payment error: ' + error.message;
            }
        }

        function calculateLuckyDirection() {
            if (!checkPaymentStatus()) {
                document.getElementById('lucky-info').innerText = 'Please subscribe for $1.99/month or buy for $14.99 to access Lucky Direction!';
                return;
            }
            const year = document.getElementById('year').value;
            const month = document.getElementById('month').value;
            const day = document.getElementById('day').value;
            if (!year || !month || !day || month < 1 || month > 12 || day < 1 || day > 31) {
                document.getElementById('lucky-info').innerText = 'Please enter a valid birth date!';
                return;
            }
            fetch(`/zen/api/bazi?year=${year}&month=${month}&day=${day}`)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        document.getElementById('lucky-info').innerText = 'Error: ' + data.error;
                    } else {
                        luckyAngle = data.angle;
                        document.getElementById('lucky-info').innerText = data.explanation;
                    }
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                    document.getElementById('lucky-info').innerText = 'Error: ' + error;
                });
        }

        function enableCompass() {
            if (!checkPaymentStatus()) {
                document.getElementById('lucky-info').innerText = 'Please subscribe for $1.99/month or buy for $14.99 to access Compass!';
                return;
            }
            if (typeof DeviceOrientationEvent === 'undefined') {
                document.getElementById('lucky-info').innerText = 'Device orientation not supported!';
                return;
            }
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            startCompass();
                        } else {
                            document.getElementById('lucky-info').innerText = 'Device orientation permission denied!';
                        }
                    })
                    .catch(error => {
                        console.error('Permission error:', error);
                        document.getElementById('lucky-info').innerText = 'Error requesting device orientation: ' + error.message;
                    });
            } else {
                startCompass();
            }
        }

        function startCompass() {
            window.addEventListener('deviceorientation', function(event) {
                const alpha = event.alpha ? Math.round(event.alpha) : 0;
                const ctx = document.getElementById('compass').getContext('2d');
                ctx.clearRect(0, 0, 200, 200);
                ctx.beginPath();
                ctx.arc(100, 100, 90, 0, 2 * Math.PI);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(100, 100);
                ctx.lineTo(100, 10);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(100, 100);
                ctx.lineTo(100 + 90 * Math.sin(luckyAngle * Math.PI / 180), 100 - 90 * Math.cos(luckyAngle * Math.PI / 180));
                ctx.strokeStyle = 'red';
                ctx.stroke();
                const diff = Math.abs(alpha - luckyAngle);
                document.getElementById('lucky-info').innerText = `Current direction: ${alpha}Â°${diff < 10 ? ' You are facing your lucky direction!' : ''}`;
            });
        }

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/zen/lucky_direction/sw.js')
                .then(() => console.log('Service Worker registered'))
                .catch(error => console.error('Service Worker error:', error));
        }
    </script>
</body>
</html>
